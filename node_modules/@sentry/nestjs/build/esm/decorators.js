import { captureException } from '@sentry/core';
import * as Sentry from '@sentry/node';
import { startSpan } from '@sentry/node';
import { isExpectedError } from './helpers.js';

/**
 * A decorator wrapping the native nest Cron decorator, sending check-ins to Sentry.
 */
const SentryCron = (monitorSlug, monitorConfig) => {
  return (target, propertyKey, descriptor) => {
    const originalMethod = descriptor.value ;

    descriptor.value = function (...args) {
      return Sentry.withMonitor(
        monitorSlug,
        () => {
          return originalMethod.apply(this, args);
        },
        monitorConfig,
      );
    };
    return descriptor;
  };
};

/**
 * A decorator usable to wrap arbitrary functions with spans.
 */
function SentryTraced(op = 'function') {
  return function (target, propertyKey, descriptor) {
    const originalMethod = descriptor.value ; // function can be sync or async

    descriptor.value = function (...args) {
      return startSpan(
        {
          op: op,
          name: propertyKey,
        },
        () => {
          return originalMethod.apply(this, args);
        },
      );
    };

    // preserve the original name on the decorated function
    Object.defineProperty(descriptor.value, 'name', {
      value: originalMethod.name,
      configurable: true,
      enumerable: true,
      writable: true,
    });

    return descriptor;
  };
}

/**
 * A decorator to wrap user-defined exception filters and add Sentry error reporting.
 */
function SentryExceptionCaptured() {
  return function (target, propertyKey, descriptor) {
    const originalCatch = descriptor.value ;

    descriptor.value = function (exception, host, ...args) {
      if (isExpectedError(exception)) {
        return originalCatch.apply(this, [exception, host, ...args]);
      }

      captureException(exception);
      return originalCatch.apply(this, [exception, host, ...args]);
    };

    return descriptor;
  };
}

/**
 * A decorator to wrap user-defined exception filters and add Sentry error reporting.
 *
 * @deprecated This decorator was renamed and will be removed in a future major version. Use `SentryExceptionCaptured` instead.
 */
const WithSentry = SentryExceptionCaptured;

export { SentryCron, SentryExceptionCaptured, SentryTraced, WithSentry };
//# sourceMappingURL=decorators.js.map
